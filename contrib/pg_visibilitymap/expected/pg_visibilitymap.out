CREATE EXTENSION pg_visibilitymap;
CREATE TABLE t1 AS SELECT * FROM generate_series(1,1000) AS p;
\d t1
      Table "public.t1"
 Column |  Type   | Modifiers 
--------+---------+-----------
 p      | integer | 

VACUUM t1;
SELECT relpages FROM pg_class WHERE relname = 't1';
 relpages 
----------
        5
(1 row)

SELECT * FROM pg_visibilitymap('t1');
 blkno | mapbits 
-------+---------
     0 |       1
     1 |       1
     2 |       1
     3 |       1
     4 |       1
(5 rows)

SELECT * FROM pg_visibility('t1');
 blkno | mapbits | pagebits 
-------+---------+----------
     0 |       1 |        4
     1 |       1 |        4
     2 |       1 |        4
     3 |       1 |        4
     4 |       1 |        4
(5 rows)

DELETE FROM t1 WHERE p < 500;
SELECT * FROM pg_visibilitymap('t1');
 blkno | mapbits 
-------+---------
     0 |       0
     1 |       0
     2 |       0
     3 |       1
     4 |       1
(5 rows)

SELECT * FROM pg_visibility('t1');
 blkno | mapbits | pagebits 
-------+---------+----------
     0 |       0 |        0
     1 |       0 |        0
     2 |       0 |        0
     3 |       1 |        4
     4 |       1 |        4
(5 rows)

VACUUM FREEZE t1;
SELECT * FROM pg_visibilitymap('t1');
 blkno | mapbits 
-------+---------
     0 |       3
     1 |       3
     2 |       3
     3 |       3
     4 |       3
(5 rows)

SELECT * FROM pg_visibility('t1');
 blkno | mapbits | pagebits 
-------+---------+----------
     0 |       3 |       13
     1 |       3 |       13
     2 |       3 |       13
     3 |       3 |       12
     4 |       3 |       12
(5 rows)

DROP TABLE t1;
--
-- Errors
--
CREATE TABLE t2 (col int primary key);
INSERT INTO t2 SELECT generate_series(1,100);
CREATE VIEW t2_view AS (SELECT * FROM t2);
CREATE MATERIALIZED VIEW t2_matview AS (SELECT * FROM t2);
SELECT pg_visibilitymap('t2', 0);
 pg_visibilitymap 
------------------
                0
(1 row)

SELECT pg_visibilitymap('t2_matview', 0);
 pg_visibilitymap 
------------------
                0
(1 row)

SELECT pg_visibilitymap('t2_view', 0); -- error
ERROR:  "t2_view" is not a table or materialized view
SELECT pg_visibilitymap('t2_pkey', 0); -- error
ERROR:  "t2_pkey" is not a table or materialized view
SELECT pg_page_flags('t2', 0);
 pg_page_flags 
---------------
             0
(1 row)

SELECT pg_page_flags('t2_matview', 0);
 pg_page_flags 
---------------
             0
(1 row)

SELECT pg_page_flags('t2_view', 0); -- error
ERROR:  "t2_view" is not a table or materialized view
SELECT pg_page_flags('t2_pkey', 0); -- error
ERROR:  "t2_pkey" is not a table or materialized view
DROP TABLE t2 CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to view t2_view
drop cascades to materialized view t2_matview
